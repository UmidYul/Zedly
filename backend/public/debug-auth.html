<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
        <link rel="icon" type="image/png" href="/images/zedly_logo_bg.png">
    <link rel="apple-touch-icon" href="/images/pwa-icon-192.png">
    <link rel="manifest" href="/manifest.webmanifest">
    <title>Auth Debug - ZEDLY</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0F1729;
            color: #E2E8F0;
            padding: 2rem;
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: #1A2332;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #4A90E2;
            margin-bottom: 1rem;
        }

        h2 {
            color: #50E3C2;
            margin-top: 2rem;
            margin-bottom: 1rem;
            font-size: 1.25rem;
        }

        .status {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status.success {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid #4CAF50;
        }

        .status.error {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid #F44336;
        }

        .status.warning {
            background: rgba(255, 152, 0, 0.2);
            border: 1px solid #FF9800;
        }

        .token-display {
            background: #0F1729;
            padding: 1rem;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            word-break: break-all;
            margin-bottom: 1rem;
        }

        button {
            background: #4A90E2;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }

        button:hover {
            background: #3A7BC8;
            transform: translateY(-2px);
        }

        button.danger {
            background: #EF5350;
        }

        button.danger:hover {
            background: #E53935;
        }

        .actions {
            margin-top: 2rem;
        }

        pre {
            background: #0F1729;
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
        }

        .label {
            font-weight: bold;
            color: #50E3C2;
            display: block;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Auth Debug Tool</h1>
        <p>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π ZEDLY</p>

        <h2>üìä –°—Ç–∞—Ç—É—Å LocalStorage</h2>
        <div id="localStorage-status"></div>

        <h2>üîë –¢–æ–∫–µ–Ω—ã</h2>
        <div id="tokens-display"></div>

        <h2>üë§ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ</h2>
        <div id="user-info"></div>

        <h2>üß™ –¢–µ—Å—Ç—ã API</h2>
        <div id="api-tests"></div>

        <div class="actions">
            <h2>‚öôÔ∏è –î–µ–π—Å—Ç–≤–∏—è</h2>
            <button onclick="testAuthMe()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å /api/auth/me</button>
            <button onclick="testRefresh()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å /api/auth/refresh</button>
            <button onclick="clearAllData()" class="danger">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ</button>
            <button onclick="location.reload()">–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</button>
        </div>
    </div>

    <script>
        // Check localStorage
        function checkLocalStorage() {
            const container = document.getElementById('localStorage-status');
            const accessToken = localStorage.getItem('access_token');
            const refreshToken = localStorage.getItem('refresh_token');
            const user = localStorage.getItem('user');

            let html = '';

            if (accessToken) {
                html += '<div class="status success">‚úÖ Access Token: –°–£–©–ï–°–¢–í–£–ï–¢</div>';
            } else {
                html += '<div class="status error">‚ùå Access Token: –û–¢–°–£–¢–°–¢–í–£–ï–¢</div>';
            }

            if (refreshToken) {
                html += '<div class="status success">‚úÖ Refresh Token: –°–£–©–ï–°–¢–í–£–ï–¢</div>';
            } else {
                html += '<div class="status error">‚ùå Refresh Token: –û–¢–°–£–¢–°–¢–í–£–ï–¢</div>';
            }

            if (user) {
                html += '<div class="status success">‚úÖ User Data: –°–£–©–ï–°–¢–í–£–ï–¢</div>';
            } else {
                html += '<div class="status error">‚ùå User Data: –û–¢–°–£–¢–°–¢–í–£–ï–¢</div>';
            }

            container.innerHTML = html;
        }

        // Display tokens
        function displayTokens() {
            const container = document.getElementById('tokens-display');
            const accessToken = localStorage.getItem('access_token');
            const refreshToken = localStorage.getItem('refresh_token');

            let html = '';

            if (accessToken) {
                html += '<span class="label">Access Token:</span>';
                html += '<div class="token-display">' + accessToken.substring(0, 50) + '...</div>';
                
                // Try to decode JWT
                try {
                    const payload = JSON.parse(atob(accessToken.split('.')[1]));
                    html += '<span class="label">Decoded Payload:</span>';
                    html += '<pre>' + JSON.stringify(payload, null, 2) + '</pre>';
                    
                    // Check expiration
                    const exp = payload.exp * 1000;
                    const now = Date.now();
                    if (exp < now) {
                        html += '<div class="status error">‚è∞ –¢–æ–∫–µ–Ω –ò–°–¢–Å–ö ' + new Date(exp).toLocaleString() + '</div>';
                    } else {
                        html += '<div class="status success">‚è∞ –¢–æ–∫–µ–Ω –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –¥–æ ' + new Date(exp).toLocaleString() + '</div>';
                    }
                } catch (e) {
                    html += '<div class="status error">‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–∫–µ–Ω</div>';
                }
            }

            if (refreshToken) {
                html += '<span class="label">Refresh Token:</span>';
                html += '<div class="token-display">' + refreshToken.substring(0, 50) + '...</div>';
            }

            container.innerHTML = html || '<div class="status warning">‚ö†Ô∏è –¢–æ–∫–µ–Ω—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</div>';
        }

        // Display user info
        function displayUserInfo() {
            const container = document.getElementById('user-info');
            const user = localStorage.getItem('user');

            if (user) {
                try {
                    const userData = JSON.parse(user);
                    container.innerHTML = '<pre>' + JSON.stringify(userData, null, 2) + '</pre>';
                } catch (e) {
                    container.innerHTML = '<div class="status error">‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>';
                }
            } else {
                container.innerHTML = '<div class="status warning">‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</div>';
            }
        }

        // Test /api/auth/me
        async function testAuthMe() {
            const container = document.getElementById('api-tests');
            container.innerHTML = '<div class="status warning">üîÑ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ /api/auth/me...</div>';

            const accessToken = localStorage.getItem('access_token');
            if (!accessToken) {
                container.innerHTML = '<div class="status error">‚ùå Access token –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</div>';
                return;
            }

            try {
                const response = await fetch('/api/auth/me', {
                    headers: {
                        'Authorization': 'Bearer ' + accessToken
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    container.innerHTML = '<div class="status success">‚úÖ /api/auth/me: –£–°–ü–ï–®–ù–û</div><pre>' + JSON.stringify(data, null, 2) + '</pre>';
                } else {
                    container.innerHTML = '<div class="status error">‚ùå /api/auth/me: –û–®–ò–ë–ö–ê ' + response.status + '</div><pre>' + JSON.stringify(data, null, 2) + '</pre>';
                }
            } catch (error) {
                container.innerHTML = '<div class="status error">‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ' + error.message + '</div>';
            }
        }

        // Test /api/auth/refresh
        async function testRefresh() {
            const container = document.getElementById('api-tests');
            container.innerHTML = '<div class="status warning">üîÑ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ /api/auth/refresh...</div>';

            const refreshToken = localStorage.getItem('refresh_token');
            if (!refreshToken) {
                container.innerHTML = '<div class="status error">‚ùå Refresh token –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</div>';
                return;
            }

            try {
                const response = await fetch('/api/auth/refresh', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ refresh_token: refreshToken })
                });

                const data = await response.json();

                if (response.ok) {
                    container.innerHTML = '<div class="status success">‚úÖ /api/auth/refresh: –£–°–ü–ï–®–ù–û</div><pre>' + JSON.stringify(data, null, 2) + '</pre>';
                    localStorage.setItem('access_token', data.access_token);
                    setTimeout(() => location.reload(), 2000);
                } else {
                    container.innerHTML = '<div class="status error">‚ùå /api/auth/refresh: –û–®–ò–ë–ö–ê ' + response.status + '</div><pre>' + JSON.stringify(data, null, 2) + '</pre>';
                }
            } catch (error) {
                container.innerHTML = '<div class="status error">‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ' + error.message + '</div>';
            }
        }

        // Clear all data
        function clearAllData() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –≠—Ç–æ —É–¥–∞–ª–∏—Ç –≤—Å–µ —Ç–æ–∫–µ–Ω—ã –∏ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.')) {
                localStorage.removeItem('access_token');
                localStorage.removeItem('refresh_token');
                localStorage.removeItem('user');
                alert('–í—Å–µ –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã!');
                location.reload();
            }
        }

        // Initialize
        checkLocalStorage();
        displayTokens();
        displayUserInfo();
    </script>
    <script src="/js/alert-modal.js"></script>
</body>
</html>
