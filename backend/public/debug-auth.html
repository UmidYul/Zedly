<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
        <link rel="icon" type="image/png" href="/images/zedly_logo_bg.png">
    <link rel="apple-touch-icon" href="/images/pwa-icon-192.png">
    <link rel="manifest" href="/manifest.webmanifest">
    <title>Auth Debug - ZEDLY</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0F1729;
            color: #E2E8F0;
            padding: 2rem;
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: #1A2332;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #4A90E2;
            margin-bottom: 1rem;
        }

        h2 {
            color: #50E3C2;
            margin-top: 2rem;
            margin-bottom: 1rem;
            font-size: 1.25rem;
        }

        .status {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status.success {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid #4CAF50;
        }

        .status.error {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid #F44336;
        }

        .status.warning {
            background: rgba(255, 152, 0, 0.2);
            border: 1px solid #FF9800;
        }

        .token-display {
            background: #0F1729;
            padding: 1rem;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            word-break: break-all;
            margin-bottom: 1rem;
        }

        button {
            background: #4A90E2;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }

        button:hover {
            background: #3A7BC8;
            transform: translateY(-2px);
        }

        button.danger {
            background: #EF5350;
        }

        button.danger:hover {
            background: #E53935;
        }

        .actions {
            margin-top: 2rem;
        }

        pre {
            background: #0F1729;
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
        }

        .label {
            font-weight: bold;
            color: #50E3C2;
            display: block;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
    </style>
<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=106838201', 'ym');

    ym(106838201, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", referrer: document.referrer, url: location.href, accurateTrackBounce:true, trackLinks:true});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/106838201" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->
</head>
<body>
    <div class="container">
        <h1>🔐 Auth Debug Tool</h1>
        <p>Диагностика проблем с аутентификацией ZEDLY</p>

        <h2>📊 Статус LocalStorage</h2>
        <div id="localStorage-status"></div>

        <h2>🔑 Токены</h2>
        <div id="tokens-display"></div>

        <h2>👤 Информация о пользователе</h2>
        <div id="user-info"></div>

        <h2>🧪 Тесты API</h2>
        <div id="api-tests"></div>

        <div class="actions">
            <h2>⚙️ Действия</h2>
            <button onclick="testAuthMe()">Проверить /api/auth/me</button>
            <button onclick="testRefresh()">Проверить /api/auth/refresh</button>
            <button onclick="clearAllData()" class="danger">Очистить все данные</button>
            <button onclick="location.reload()">Обновить страницу</button>
        </div>
    </div>

    <script>
        // Check localStorage
        function checkLocalStorage() {
            const container = document.getElementById('localStorage-status');
            const accessToken = localStorage.getItem('access_token');
            const refreshToken = localStorage.getItem('refresh_token');
            const user = localStorage.getItem('user');

            let html = '';

            if (accessToken) {
                html += '<div class="status success">✅ Access Token: СУЩЕСТВУЕТ</div>';
            } else {
                html += '<div class="status error">❌ Access Token: ОТСУТСТВУЕТ</div>';
            }

            if (refreshToken) {
                html += '<div class="status success">✅ Refresh Token: СУЩЕСТВУЕТ</div>';
            } else {
                html += '<div class="status error">❌ Refresh Token: ОТСУТСТВУЕТ</div>';
            }

            if (user) {
                html += '<div class="status success">✅ User Data: СУЩЕСТВУЕТ</div>';
            } else {
                html += '<div class="status error">❌ User Data: ОТСУТСТВУЕТ</div>';
            }

            container.innerHTML = html;
        }

        // Display tokens
        function displayTokens() {
            const container = document.getElementById('tokens-display');
            const accessToken = localStorage.getItem('access_token');
            const refreshToken = localStorage.getItem('refresh_token');

            let html = '';

            if (accessToken) {
                html += '<span class="label">Access Token:</span>';
                html += '<div class="token-display">' + accessToken.substring(0, 50) + '...</div>';
                
                // Try to decode JWT
                try {
                    const payload = JSON.parse(atob(accessToken.split('.')[1]));
                    html += '<span class="label">Decoded Payload:</span>';
                    html += '<pre>' + JSON.stringify(payload, null, 2) + '</pre>';
                    
                    // Check expiration
                    const exp = payload.exp * 1000;
                    const now = Date.now();
                    if (exp < now) {
                        html += '<div class="status error">⏰ Токен ИСТЁК ' + new Date(exp).toLocaleString() + '</div>';
                    } else {
                        html += '<div class="status success">⏰ Токен действителен до ' + new Date(exp).toLocaleString() + '</div>';
                    }
                } catch (e) {
                    html += '<div class="status error">❌ Не удалось декодировать токен</div>';
                }
            }

            if (refreshToken) {
                html += '<span class="label">Refresh Token:</span>';
                html += '<div class="token-display">' + refreshToken.substring(0, 50) + '...</div>';
            }

            container.innerHTML = html || '<div class="status warning">⚠️ Токены отсутствуют</div>';
        }

        // Display user info
        function displayUserInfo() {
            const container = document.getElementById('user-info');
            const user = localStorage.getItem('user');

            if (user) {
                try {
                    const userData = JSON.parse(user);
                    container.innerHTML = '<pre>' + JSON.stringify(userData, null, 2) + '</pre>';
                } catch (e) {
                    container.innerHTML = '<div class="status error">❌ Ошибка парсинга данных пользователя</div>';
                }
            } else {
                container.innerHTML = '<div class="status warning">⚠️ Данные пользователя отсутствуют</div>';
            }
        }

        // Test /api/auth/me
        async function testAuthMe() {
            const container = document.getElementById('api-tests');
            container.innerHTML = '<div class="status warning">🔄 Тестирование /api/auth/me...</div>';

            const accessToken = localStorage.getItem('access_token');
            if (!accessToken) {
                container.innerHTML = '<div class="status error">❌ Access token отсутствует</div>';
                return;
            }

            try {
                const response = await fetch('/api/auth/me', {
                    headers: {
                        'Authorization': 'Bearer ' + accessToken
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    container.innerHTML = '<div class="status success">✅ /api/auth/me: УСПЕШНО</div><pre>' + JSON.stringify(data, null, 2) + '</pre>';
                } else {
                    container.innerHTML = '<div class="status error">❌ /api/auth/me: ОШИБКА ' + response.status + '</div><pre>' + JSON.stringify(data, null, 2) + '</pre>';
                }
            } catch (error) {
                container.innerHTML = '<div class="status error">❌ Ошибка запроса: ' + error.message + '</div>';
            }
        }

        // Test /api/auth/refresh
        async function testRefresh() {
            const container = document.getElementById('api-tests');
            container.innerHTML = '<div class="status warning">🔄 Тестирование /api/auth/refresh...</div>';

            const refreshToken = localStorage.getItem('refresh_token');
            if (!refreshToken) {
                container.innerHTML = '<div class="status error">❌ Refresh token отсутствует</div>';
                return;
            }

            try {
                const response = await fetch('/api/auth/refresh', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ refresh_token: refreshToken })
                });

                const data = await response.json();

                if (response.ok) {
                    container.innerHTML = '<div class="status success">✅ /api/auth/refresh: УСПЕШНО</div><pre>' + JSON.stringify(data, null, 2) + '</pre>';
                    localStorage.setItem('access_token', data.access_token);
                    setTimeout(() => location.reload(), 2000);
                } else {
                    container.innerHTML = '<div class="status error">❌ /api/auth/refresh: ОШИБКА ' + response.status + '</div><pre>' + JSON.stringify(data, null, 2) + '</pre>';
                }
            } catch (error) {
                container.innerHTML = '<div class="status error">❌ Ошибка запроса: ' + error.message + '</div>';
            }
        }

        // Clear all data
        function clearAllData() {
            if (confirm('Вы уверены? Это удалит все токены и данные пользователя.')) {
                localStorage.removeItem('access_token');
                localStorage.removeItem('refresh_token');
                localStorage.removeItem('user');
                alert('Все данные очищены!');
                location.reload();
            }
        }

        // Initialize
        checkLocalStorage();
        displayTokens();
        displayUserInfo();
    </script>
    <script src="/js/alert-modal.js"></script>
</body>
</html>

